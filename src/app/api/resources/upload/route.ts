import { NextResponse } from "next/server";
import { auth } from "@/auth";
import { writeFile, mkdir } from "fs/promises";
import { join } from "path";
import { existsSync } from "fs";

const UPLOAD_DIR = join(process.cwd(), "public", "uploads", "resources");
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB for documents
const ALLOWED_TYPES = [
    "image/png", "image/jpeg", "image/webp", "image/gif",
    "application/pdf",
    "application/msword",
    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "application/vnd.ms-excel",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "application/vnd.ms-powerpoint",
    "application/vnd.openxmlformats-officedocument.presentationml.presentation",
    "text/plain",
];

export async function POST(req: Request) {
    try {
        const session = await auth();

        if (!session || !session.user || !session.user.id) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const formData = await req.formData();
        const file = formData.get("file") as File;

        if (!file) {
            return NextResponse.json({ error: "No file provided" }, { status: 400 });
        }

        // Validate file type
        if (!ALLOWED_TYPES.includes(file.type)) {
            return NextResponse.json({
                error: "Formato no permitido. Solo imágenes, PDF, documentos de Office y texto plano."
            }, { status: 400 });
        }

        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
            return NextResponse.json({
                error: "Archivo muy grande. Máximo 20MB."
            }, { status: 400 });
        }

        // Create upload directory if it doesn't exist
        if (!existsSync(UPLOAD_DIR)) {
            await mkdir(UPLOAD_DIR, { recursive: true });
        }

        // Generate unique filename
        const timestamp = Date.now();
        const extension = file.name.split('.').pop() || 'file';
        const safeOriginalName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_').substring(0, 50);
        const filename = `${timestamp}-${safeOriginalName}`;
        const filepath = join(UPLOAD_DIR, filename);

        // Convert file to buffer and save
        const bytes = await file.arrayBuffer();
        const buffer = Buffer.from(bytes);
        await writeFile(filepath, buffer);

        // Return the public URL
        const fileUrl = `/uploads/resources/${filename}`;

        return NextResponse.json({
            success: true,
            fileUrl,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size
        });

    } catch (error: any) {
        console.error("[UPLOAD RESOURCE] Error:", error);
        return NextResponse.json({
            error: "Error al subir el archivo",
            details: error?.message
        }, { status: 500 });
    }
}
