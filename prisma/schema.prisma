generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  image          String?
  password       String
  role           Role      @default(MEMBER)
  isStaff        Boolean   @default(false)
  ministryId     String?
  ministry       Ministry? @relation(fields: [ministryId], references: [id])
  
  // Supervisor is a simple string (name from SUPERVISORS list), not a relation
  supervisorName String?
  
  // Staff identity is a simple string (name from STAFF_MEMBERS list) for conflict checking
  staffName      String?
  
  supervisedEvents Event[] @relation("EventSupervisor")
  assignments    Assignment[]
  activities     Activity[]
  updates        ActivityUpdate[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Ministry {
  id          String   @id @default(cuid())
  name        String
  users       User[]
  events      Event[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Event {
  id          String       @id @default(cuid())
  title       String
  description String?
  date        DateTime
  startTime   DateTime?
  endTime     DateTime?
  type        EventType    @default(GENERAL)
  
  ministryId  String?
  ministry    Ministry?    @relation(fields: [ministryId], references: [id])
  
  supervisorId String?
  supervisor   User?       @relation("EventSupervisor", fields: [supervisorId], references: [id])
  
  staffName    String?
  supervisorName String?

  
  assignments Assignment[]
  tags        Tag[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Assignment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id])
  role      String?  // e.g., "Worship Leader", "Usher"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id      String  @id @default(cuid())
  name    String
  color   String? // For UI display
  events  Event[]
}

model Conflict {
  id          String   @id @default(cuid())
  title       String
  date        DateTime
  description String?
  source      String?   // "External Ministry", "Main Church Calendar"
  affectedUserIds String? // JSON string or relation could be better, keeping simple for now
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Role {
  ADMIN
  LEADER
  MEMBER
}

enum EventType {
  GENERAL
  CHURCH_MEETING_VISTA_AL_MAR
  CHURCH_MEETING_CENTRO
  GROUPS
  GENERAL_GROUP_MEETING
  SPECIAL_EVENT
  ONE_EIGHTY
  DISCIPLESHIP
  SMILES
  NO_MEETING
}

model Invitation {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  token     String   @unique
  status    InvitationStatus @default(PENDING)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Activity {
  id            String   @id @default(cuid())
  name          String
  description   String?  @db.Text
  icon          String   // Name of the lucide icon
  color         String   // Hex color or Tailwind class
  
  responsibleId String
  responsible   User     @relation(fields: [responsibleId], references: [id])
  status        ActivityStatus @default(PENDING)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  updates       ActivityUpdate[]
}

model ActivityUpdate {
  id          String   @id @default(cuid())
  title       String   @default("") // Added title field
  content     String   @db.Text
  createdAt   DateTime @default(now())
  
  activityId  String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
}

enum ActivityStatus {
  PENDING
  CANCELLED
}

// Resource Model
model Resource {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  category    String
  type        String
  fileUrl     String?  // URL for uploaded files or external links
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// FollowUp Model (Personas en seguimiento)
model FollowUp {
  id              String   @id @default(cuid())
  evangelizer     String   // Quién atendió
  date            DateTime // Fecha de contacto
  fullName        String   // Nombre de la persona
  whatsapp        String   // Contacto
  email           String?  // Opcional
  acceptedJesus   String   // "Sí", "No", "Ya era creyente"
  reason          String   // Motivo de visita
  agreedToFollowUp String // "Sí", "No"
  observations    String?
  status          String   @default("PENDING") // PENDING, CONTACTED, VISITED, ARCHIVED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Calendar Agent Files
model CalendarFile {
  id        String   @id @default(cuid())
  fileName  String
  fileSize  Int      // in bytes
  content   String?  @db.Text // Text content extracted if applicable
  uploadedBy String
  createdAt DateTime @default(now())
}
